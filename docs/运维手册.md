# 运维手册 - AI内容生成助手

## 🚨 紧急故障处理

### 网站无法访问 - 快速恢复
当 http://8.154.36.16:5004 无法访问时，执行以下步骤：

```bash
# 1. 立即重启服务器（推荐方式）
ssh root@8.154.36.16 "/opt/content-generator/server-daemon.sh"
```

如果上述命令失败，使用手动方式：
```bash
# 2. 手动清理和重启
ssh root@8.154.36.16 "pkill -f 'node server.js' && cd /opt/content-generator/backend && nohup node server.js > /tmp/server.log 2>&1 &"
```

### 常见错误信息及解决方案

#### 错误1: ERR_CONNECTION_RESET
**症状**: 前端无法连接后端API
**原因**: 多个服务器进程冲突
**解决**:
```bash
ssh root@8.154.36.16 "/opt/content-generator/server-daemon.sh"
```

#### 错误2: userService is not defined
**症状**: 认证中间件报错
**原因**: 变量作用域问题
**解决**: 已修复，如果再次出现需要更新 `backend/middleware/auth.js`

#### 错误3: 端口5004被占用
**症状**: 服务器启动失败，提示 EADDRINUSE
**原因**: 旧进程未正确清理
**解决**:
```bash
ssh root@8.154.36.16 "pkill -f 'node server.js' && sleep 3"
ssh root@8.154.36.16 "/opt/content-generator/server-daemon.sh"
```

## 📊 服务器监控

### 检查服务器状态
```bash
# 检查进程是否运行
ssh root@8.154.36.16 "ps -p \$(cat /tmp/content-generator.pid)"

# 检查HTTP服务响应
curl -s http://8.154.36.16:5004/api/about

# 查看服务器日志
ssh root@8.154.36.16 "tail -20 /tmp/content-generator.log"
```

### 性能监控
```bash
# 查看服务器资源使用
ssh root@8.154.36.16 "top -p \$(cat /tmp/content-generator.pid)"

# 查看内存使用
ssh root@8.154.36.16 "free -h"

# 查看磁盘使用
ssh root@8.154.36.16 "df -h"
```

## 🚀 部署流程

### 标准部署流程
1. **前端构建**
```bash
cd frontend
npm run build
```

2. **执行稳定部署脚本**
```bash
./deploy-stable.sh
```

### 仅更新前端
```bash
cd frontend
npm run build
scp -r dist/* root@8.154.36.16:/opt/content-generator/frontend/dist/
```

### 仅更新后端
```bash
scp backend/server.js root@8.154.36.16:/opt/content-generator/backend/
ssh root@8.154.36.16 "/opt/content-generator/server-daemon.sh"
```

### 紧急回滚
如果部署出现问题，可以快速回滚：
```bash
# 恢复稳定版本（需要提前备份）
ssh root@8.154.36.16 "cp /opt/content-generator/backup/* /opt/content-generator/backend/"
ssh root@8.154.36.16 "/opt/content-generator/server-daemon.sh"
```

## 🗄️ 数据库维护

### 数据库备份
```bash
# 创建数据库备份
ssh root@8.154.36.16 "cp /opt/content-generator/backend/content_generator.db /opt/content-generator/backup/db_backup_\$(date +%Y%m%d_%H%M%S).db"
```

### 数据库重置（谨慎操作）
```bash
# 重新初始化数据库
ssh root@8.154.36.16 "cd /opt/content-generator/backend && node -e \"require('./database/init-safe.js').initDatabase()\""
```

### 查看数据库状态
```bash
ssh root@8.154.36.16 "ls -la /opt/content-generator/backend/*.db"
```

## 🔧 配置管理

### 环境变量
主要配置文件位置：
- 服务器配置: `/opt/content-generator/backend/server.js`
- 数据库配置: `/opt/content-generator/backend/database/`

### 重要配置项
- 端口号: 5004
- 数据库文件: `content_generator.db`
- 日志文件: `/tmp/content-generator.log`
- PID文件: `/tmp/content-generator.pid`

## 🛡️ 安全维护

### 定期安全检查
```bash
# 检查异常登录
ssh root@8.154.36.16 "last | head -20"

# 检查系统负载
ssh root@8.154.36.16 "uptime"

# 检查网络连接
ssh root@8.154.36.16 "netstat -tlnp | grep 5004"
```

### 日志分析
```bash
# 查看错误日志
ssh root@8.154.36.16 "grep -i error /tmp/content-generator.log"

# 查看API调用频率
ssh root@8.154.36.16 "grep -c 'API调用' /tmp/content-generator.log"
```

## 📋 定期维护任务

### 每日检查清单
- [ ] 检查服务器是否正常运行
- [ ] 检查日志是否有异常错误
- [ ] 验证网站访问是否正常
- [ ] 检查数据库文件大小

### 每周维护任务
- [ ] 创建数据库备份
- [ ] 清理旧日志文件
- [ ] 检查磁盘空间使用
- [ ] 更新系统补丁（如需要）

### 每月维护任务
- [ ] 性能分析和优化
- [ ] 用户数据统计
- [ ] 服务器资源评估
- [ ] 安全审计

## 📞 紧急联系方式

### 技术支持
- **主要维护**: Claude Code Assistant
- **业务联系**: 广西蒙太奇影视传媒有限公司
- **联系电话**: 13978445003
- **微信号**: 13978445003

### 故障升级流程
1. **Level 1**: 使用自动化脚本尝试修复
2. **Level 2**: 手动诊断和修复
3. **Level 3**: 联系技术支持
4. **Level 4**: 业务方通知和应急方案

## 🔄 常用运维脚本

### 服务器健康检查脚本
```bash
#!/bin/bash
# health-check.sh
echo "=== 服务器健康检查 ==="
ssh root@8.154.36.16 "
echo '1. 进程状态:'
ps -p \$(cat /tmp/content-generator.pid) || echo '进程未运行'

echo '2. HTTP响应:'
curl -s --connect-timeout 5 http://localhost:5004/api/about > /dev/null && echo 'HTTP服务正常' || echo 'HTTP服务异常'

echo '3. 磁盘使用:'
df -h | grep -E '(Filesystem|/dev/)'

echo '4. 内存使用:'
free -h

echo '5. 最近错误:'
tail -5 /tmp/content-generator.log | grep -i error || echo '无错误日志'
"
```

### 日志清理脚本
```bash
#!/bin/bash
# cleanup-logs.sh
ssh root@8.154.36.16 "
# 保留最近1000行日志
tail -1000 /tmp/content-generator.log > /tmp/content-generator.log.tmp
mv /tmp/content-generator.log.tmp /tmp/content-generator.log
echo '日志清理完成'
"
```

---

**最后更新**: 2025年9月28日
**维护团队**: Claude Code Assistant + 萌太奇技术团队