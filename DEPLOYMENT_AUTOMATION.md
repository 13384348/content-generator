# 🚀 自动化部署指南

## 📋 概述

为了避免手动部署过程中的错误和遗漏，我创建了自动化部署脚本，你只需要运行一个命令就能完成整个服务器部署流程。

## 🛠️ 可用的部署命令

### 1. Windows系统（推荐）
```cmd
# 简单方式
deploy.cmd

# 或者直接运行
deploy-to-server.bat
```

### 2. Linux/Mac系统
```bash
# 添加执行权限（仅第一次）
chmod +x deploy-to-server.sh

# 执行部署
./deploy-to-server.sh
```

## ⚡ 一键部署流程

当你运行部署命令时，脚本会自动执行以下步骤：

### 🔍 部署前检查
- ✅ 检查项目目录结构
- ✅ 验证服务器SSH连接
- ✅ 检查Git工作目录状态
- ✅ 执行本地构建测试
- ✅ 验证前后端数据一致性

### 📤 代码同步
- ✅ 自动提交本地更改
- ✅ 推送到远程Git仓库
- ✅ 创建时间戳提交信息

### 🚀 服务器部署
- ✅ 停止旧服务进程
- ✅ 备份现有代码
- ✅ 克隆最新代码
- ✅ 安装依赖包
- ✅ 构建生产版本
- ✅ 配置生产环境
- ✅ 启动新服务

### 🔍 部署验证
- ✅ 健康检查API
- ✅ 前端页面访问测试
- ✅ 核心功能验证
- ✅ 显示部署结果

## 📊 部署结果示例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 🎉 部署完成！

📊 部署信息:
  🌐 网站地址: http://8.154.36.16:5004
  📁 部署路径: /opt/content-generator
  📦 备份路径: /opt/content-generator-backup-20250927_235959
  ⏰ 部署时间: 2025-09-27 23:59:59

🔍 快速检查命令:
  服务状态: ssh root@8.154.36.16 "ps aux | grep node"
  查看日志: ssh root@8.154.36.16 "tail -f /opt/content-generator/backend/app.log"
  重启服务: ssh root@8.154.36.16 "cd /opt/content-generator/backend && pkill -f node && nohup node server.js > app.log 2>&1 &"
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 🛡️ 安全特性

### 自动备份
- 每次部署前自动备份现有代码
- 备份路径包含时间戳，避免覆盖
- 部署失败时可快速回滚

### 错误处理
- 任何步骤失败时自动停止
- 显示详细错误信息
- 提供故障排除建议

### 验证机制
- 部署前本地构建验证
- 部署后功能完整性检查
- 确保服务正常启动

## 🚨 故障排除

### 常见问题

#### 1. SSH连接失败
```
❌ 无法连接到服务器 8.154.36.16
```
**解决方案**：
- 检查网络连接
- 确认SSH密钥配置正确
- 验证服务器IP地址

#### 2. 构建失败
```
❌ 前端构建失败，请修复后重试
```
**解决方案**：
- 检查代码语法错误
- 确认依赖包安装完整
- 查看构建错误日志

#### 3. 健康检查失败
```
❌ 健康检查失败
```
**解决方案**：
- 查看服务器日志：`ssh root@8.154.36.16 'tail -20 /opt/content-generator/backend/app.log'`
- 检查端口是否被占用
- 验证环境变量配置

### 手动回滚
如果部署失败需要回滚：
```bash
# 连接服务器
ssh root@8.154.36.16

# 停止当前服务
pkill -f 'node.*server.js'

# 恢复备份（替换为实际备份路径）
mv /opt/content-generator /opt/content-generator-failed
mv /opt/content-generator-backup-YYYYMMDD_HHMMSS /opt/content-generator

# 重启服务
cd /opt/content-generator/backend
nohup node server.js > app.log 2>&1 &
```

## 🔧 自定义配置

### 修改服务器信息
编辑 `deploy-to-server.bat` 或 `deploy-to-server.sh` 文件：
```bash
# 配置变量
set SERVER_IP=你的服务器IP
set SERVER_USER=你的用户名
set PROJECT_PATH=你的项目路径
```

### 添加自定义检查
在脚本中添加你的特定检查逻辑：
```bash
# 在部署前检查函数中添加
custom_check() {
    # 你的自定义检查逻辑
}
```

## 📝 最佳实践

1. **部署前测试**：确保本地功能完全正常
2. **小批量部署**：避免一次性推送大量更改
3. **监控日志**：部署后查看应用日志确认正常
4. **备份验证**：定期验证备份的完整性
5. **文档同步**：更新部署文档和检查清单

## 🎯 使用建议

### 日常开发流程
1. 完成功能开发和本地测试
2. 运行 `deploy.cmd` 一键部署
3. 验证线上功能正常
4. 如有问题，查看部署日志排查

### 紧急修复流程
1. 快速修复代码
2. 本地验证修复效果
3. 立即运行 `deploy.cmd` 部署
4. 监控服务恢复情况

---

**📞 技术支持**：如遇到部署问题，请提供完整的错误日志信息
**🔄 更新频率**：建议每次功能完成后立即部署，避免积累过多更改